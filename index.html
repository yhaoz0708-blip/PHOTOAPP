<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Media Gallery Ultimate</title>
    <style>
        :root { --uber-black: #000000; --uber-white: #ffffff; --uber-gray: #141414; --uber-border: #333333; --netflix-red: #e50914; --uber-blue: #276ef1; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--uber-black); color: var(--uber-white); margin: 0; padding: 0; }
        
        /* Navigation */
        nav { background: rgba(0,0,0,0.9); padding: 18px 0; display: flex; justify-content: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        nav a { color: #afafaf; text-decoration: none; font-size: 14px; font-weight: 500; margin: 0 25px; letter-spacing: 0.5px; }
        nav a.active { color: var(--uber-white); border-bottom: 2px solid var(--netflix-red); padding-bottom: 5px; }

        .container { max-width: 800px; margin: auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px; }

        /* Netflix List */
        .item-card { position: relative; width: 100%; aspect-ratio: 16/9; background: var(--uber-gray); border-radius: 8px; overflow: hidden; margin-bottom: 25px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .item-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .item-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 15px; }
        .item-code { font-weight: 700; font-size: 18px; }

        /* Detail View */
        .detail-hero { width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .detail-hero img { width: 100%; height: 100%; object-fit: cover; }
        
        /* 連結說明欄位樣式 */
        .info-box { background: var(--uber-gray); padding: 15px; border-radius: 8px; border-left: 4px solid var(--uber-blue); margin-bottom: 25px; }
        .link-btn { display: inline-flex; align-items: center; color: var(--uber-blue); text-decoration: none; font-weight: 600; margin-top: 10px; font-size: 15px; }
        .link-btn:after { content: ' ↗'; margin-left: 4px; }

        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .gallery-item { position: relative; aspect-ratio: 16/9; background: #222; border-radius: 6px; overflow: hidden; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Buttons */
        .btn-black { background: var(--uber-white); color: var(--uber-black); border: none; padding: 14px; font-size: 16px; font-weight: 700; border-radius: 4px; width: 100%; cursor: pointer; margin-top: 20px; }
        .btn-outline { background: transparent; color: var(--uber-white); border: 1px solid #555; padding: 8px 16px; font-weight: 600; border-radius: 4px; }

        /* Form Controls */
        .uber-input { width: 100%; background: #333; border: none; padding: 14px; font-size: 16px; border-radius: 4px; margin-top: 8px; color: white; outline: none; margin-bottom: 10px; }
        .form-label { font-size: 14px; color: #aaa; margin-top: 10px; display: block; }

        .edit-badge { position: absolute; top: 8px; right: 8px; background: var(--netflix-red); color: white; border-radius: 50%; width: 28px; height: 28px; text-align: center; line-height: 28px; font-weight: bold; display: none; border: 2px solid white; }
        .is-editing .edit-badge { display: block; }
        .is-editing img { opacity: 0.4; }

        /* Lightbox */
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; overflow: auto; }
        #lightbox-container { min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 10px; }
        #lightbox img { max-width: 100%; border-radius: 4px; }
    </style>
</head>
<body>

<nav>
    <a href="#list" id="nav-list">首頁庫</a>
    <a href="#upload" id="nav-upload">新增</a>
</nav>

<div class="container">
    <div id="list" class="page active">
        <h2>正在探索</h2>
        <div id="list-content"></div>
    </div>

    <div id="view" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="view-code-label" style="margin:0; color:var(--netflix-red);">ID</h2>
            <button class="btn-outline" onclick="toggleEdit()">管理</button>
        </div>
        <div id="view-info-area"></div>
        <div id="view-body"></div>
        <button id="del-btn" class="btn-black" style="background:#b9090b; color:white; display:none;" onclick="deleteAlbum()">刪除相簿</button>
    </div>

    <div id="upload" class="page">
        <h2>新增相簿資料</h2>
        <span class="form-label">識別編號 (CODE)</span>
        <input type="text" id="up-code" class="uber-input" placeholder="例如: NF-2024">
        
        <span class="form-label">說明 / 連結</span>
        <input type="text" id="up-link" class="uber-input" placeholder="貼上外部網址 http://...">

        <span class="form-label">封面縮圖 (16:9)</span>
        <input type="file" id="up-cover" class="uber-input" accept="image/*">
        
        <span class="form-label">內容相片 (16:9 / 多選)</span>
        <input type="file" id="up-gallery" class="uber-input" accept="image/*" multiple>
        
        <button class="btn-black" onclick="startUpload()">確認儲存</button>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
    <div id="lightbox-container"><img id="lb-img"></div>
</div>

<script>
    let db;
    let isEditMode = false;

    // DB 初始化
    const req = indexedDB.open("MediaUltimateDB", 1);
    req.onupgradeneeded = e => { 
        let store = e.target.result.createObjectStore("albums", { keyPath: "code" });
    };
    req.onsuccess = e => { db = e.target.result; router(); };

    window.addEventListener('hashchange', router);
    function router() {
        const page = (window.location.hash || '#list').substring(1).split('?')[0];
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        if(document.getElementById(page)) document.getElementById(page).classList.add('active');
        if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
        if(page === 'list') renderList();
        if(page === 'view') { isEditMode = false; renderView(); }
    }

    // 16:9 裁切
    async function crop(file) {
        return new Promise(res => {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ratio = 16/9;
                let w = img.width, h = img.height;
                if (w / h > ratio) w = h * ratio; else h = w / ratio;
                canvas.width = 1280; canvas.height = 720;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, (img.width-w)/2, (img.height-h)/2, w, h, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(b => res(b), 'image/jpeg', 0.85);
            };
        });
    }

    async function startUpload() {
        const code = document.getElementById('up-code').value.trim();
        const link = document.getElementById('up-link').value.trim();
        const coverF = document.getElementById('up-cover').files[0];
        const gallF = Array.from(document.getElementById('up-gallery').files);
        
        if(!code || !coverF) return alert("請填寫識別碼與封面");

        const cBlob = await crop(coverF);
        const gBlobs = [];
        for(let f of gallF) gBlobs.push(await crop(f));

        const tx = db.transaction("albums", "readwrite");
        tx.objectStore("albums").put({ code, link, cover: cBlob, gallery: gBlobs });
        tx.oncomplete = () => { window.location.hash = "#list"; location.reload(); };
    }

    function renderList() {
        const container = document.getElementById('list-content');
        container.innerHTML = '';
        db.transaction("albums").objectStore("albums").getAll().onsuccess = e => {
            e.target.result.forEach(item => {
                const url = URL.createObjectURL(item.cover);
                container.innerHTML += `
                    <div class="item-card" onclick="location.hash='#view?code=${item.code}'">
                        <img src="${url}">
                        <div class="item-overlay">
                            <div class="item-code">${item.code}</div>
                        </div>
                    </div>`;
            });
        };
    }

    function renderView() {
        const code = new URLSearchParams(location.hash.split('?')[1]).get('code');
        db.transaction("albums").objectStore("albums").get(code).onsuccess = e => {
            const item = e.target.result;
            if(!item) return;
            document.getElementById('view-code-label').innerText = item.code;
            document.getElementById('del-btn').style.display = isEditMode ? 'block' : 'none';
            
            // 顯示連結說明欄位
            const infoArea = document.getElementById('view-info-area');
            if(item.link) {
                infoArea.innerHTML = `
                    <div class="info-box">
                        <div style="font-size:13px; color:#888;">作品說明與連結</div>
                        <a href="${item.link}" target="_blank" class="link-btn">開啟外部連結</a>
                    </div>`;
            } else {
                infoArea.innerHTML = '';
            }

            const body = document.getElementById('view-body');
            const cUrl = URL.createObjectURL(item.cover);
            body.innerHTML = `
                <div class="${isEditMode ? 'is-editing' : ''}">
                    <div class="detail-hero"><img src="${cUrl}"></div>
                    <div class="gallery-grid">
                        ${item.gallery.map((b, idx) => {
                            const u = URL.createObjectURL(b);
                            return `<div class="gallery-item">
                                <img src="${u}" onclick="openLightbox('${u}')">
                                <div class="edit-badge" onclick="deleteSingle('${item.code}', ${idx})">✕</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        };
    }

    function openLightbox(src) {
        if(isEditMode) return;
        document.getElementById('lb-img').src = src;
        document.getElementById('lightbox').style.display = 'block';
    }

    function toggleEdit() {
        isEditMode = !isEditMode;
        renderView();
    }

    function deleteSingle(code, idx) {
        const tx = db.transaction("albums", "readwrite");
        const store = tx.objectStore("albums");
        store.get(code).onsuccess = e => {
            const d = e.target.result;
            d.gallery.splice(idx, 1);
            store.put(d).onsuccess = () => renderView();
        };
    }

    function deleteAlbum() {
        const code = document.getElementById('view-code-label').innerText;
        if(confirm("確定刪除此相簿？")) {
            db.transaction("albums", "readwrite").objectStore("albums").delete(code).onsuccess = () => location.hash = "#list";
        }
    }
</script>
</body>
</html>
